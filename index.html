<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ARC Stock Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121826;
      --accent: #00ffcc;
      --accent2: #ff3b3b;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }

    * { box-sizing: border-box; font-family: Segoe UI, Tahoma, sans-serif; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #101826, var(--bg));
      color: var(--text);
    }

    header {
      padding: 20px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { color: var(--accent); margin: 0; letter-spacing: 2px; }

    main { max-width: 1200px; margin: auto; padding: 20px; }

    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tabs button {
      background: #0b1220;
      border: 1px solid #1f2937;
      color: var(--text);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    .tabs button.active {
      background: linear-gradient(135deg, var(--accent), #00bfa5);
      color: #000;
      font-weight: bold;
    }

    .tab { display: none; }
    .tab.active { display: block; }

    .add-form {
      background: var(--panel);
      padding: 16px;
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr 120px 1fr 120px;
      gap: 10px;
      margin-bottom: 20px;
      border: 1px solid #1f2937;
    }

    .add-form input, .add-form button {
      background: #0b1220;
      border: 1px solid #1f2937;
      color: var(--text);
      padding: 10px;
      border-radius: 6px;
    }

    .add-form button {
      background: linear-gradient(135deg, var(--accent), #00bfa5);
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
    }

    .card {
      background: linear-gradient(180deg, #121826, #0b1220);
      border: 1px solid #1f2937;
      border-radius: 12px;
      overflow: hidden;
    }

    .card img { width: 100%; height: 160px; object-fit: cover; }
    .card .content { padding: 12px; }
    .card h3 { margin: 0 0 6px; color: var(--accent); }

    .qty { margin-bottom: 10px; }
    .low { color: var(--accent2); font-weight: bold; }

    footer { text-align: center; color: var(--muted); font-size: 12px; padding: 15px; }

    .error {
      background: #2b0f14;
      border: 1px solid #ff3b3b;
      color: #ffb4b4;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
  </style>
</head>
<body>

<header>
  <h1>ARC STOCK CONTROL</h1>
  <span style="color:var(--muted)">Google Sheets ‚Ä¢ Tempo real</span>
</header>

<main>
  <div id="errorBox" class="error"></div>

  <div class="tabs">
    <button class="active" onclick="openTab(event,'estoque')">Estoque</button>
    <button onclick="openTab(event,'dashboard')">Dashboard</button>
  </div>

  <section id="estoque" class="tab active">
    <div class="add-form">
      <input id="name" placeholder="Nome do produto">
      <input id="qty" type="number" placeholder="Qtd">
      <input id="img" placeholder="URL da imagem">
      <button onclick="addItem()">Adicionar</button>
    </div>
    <div class="grid" id="grid"></div>
  </section>

  <section id="dashboard" class="tab">
    <h2 style="color:var(--accent)">Dashboard</h2>
    <canvas id="chart" width="400" height="300"></canvas>
  </section>
</main>

<footer>Sistema de estoque ‚Ä¢ Google Sheets</footer>

<script>
// üîó URL DO APPS SCRIPT (Web App publicado como "Qualquer pessoa")
const API_URL = 'https://script.google.com/macros/s/AKfycbws47KiVoW0remngppcIKMuSZwf4PB41g0SwBHgL_oAwFiEA6ln-KAXIGnukimX_Nuz/exec';

let items = [];

function showError(msg) {
  const box = document.getElementById('errorBox');
  box.style.display = 'block';
  box.textContent = msg;
}

function hideError() {
  const box = document.getElementById('errorBox');
  box.style.display = 'none';
}

function openTab(e, id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  e.target.classList.add('active');
  if (id === 'dashboard') renderChart();
}

async function carregarEstoque() {
  try {
    hideError();
    const res = await fetch(API_URL, { method: 'GET', mode: 'cors' });
    if (!res.ok) throw new Error('Resposta inv√°lida da API');

    const data = await res.json();

    items = data.map(r => ({
      id: r[0],
      name: r[1],
      qty: Number(r[2]),
      img: r[3]
    }));

    render();
  } catch (err) {
    showError('Erro ao conectar com o Google Sheets. Verifique se o Apps Script est√° publicado como Web App e acess√≠vel ao p√∫blico.');
    console.error(err);
  }
}

async function addItem() {
  const name = document.getElementById('name').value.trim();
  const qty = parseInt(document.getElementById('qty').value);
  const img = document.getElementById('img').value || 'https://via.placeholder.com/400x300';

  if (!name || isNaN(qty)) return;

  try {
    await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'add',
        nome: name,
        quantidade: qty,
        imagem: img
      })
    });

    document.getElementById('name').value = '';
    document.getElementById('qty').value = '';
    document.getElementById('img').value = '';

    carregarEstoque();
  } catch (err) {
    showError('Falha ao salvar no Google Sheets.');
    console.error(err);
  }
}

function render() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  if (items.length === 0) {
    grid.innerHTML = '<p style="color:#9ca3af">Nenhum item cadastrado.</p>';
    return;
  }

  items.forEach(it => {
    const low = it.qty <= 3 ? 'low' : '';
    grid.innerHTML += `
      <div class="card">
        <img src="${it.img}">
        <div class="content">
          <h3>${it.name}</h3>
          <div class="qty ${low}">Quantidade: ${it.qty}</div>
        </div>
      </div>`;
  });
}

function renderChart() {
  const c = document.getElementById('chart');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);

  const total = items.reduce((a,b)=>a+b.qty,0) || 1;
  let start = 0;

  items.forEach(it => {
    const angle = (it.qty / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(200,150);
    ctx.arc(200,150,100,start,start+angle);
    ctx.closePath();
    ctx.fillStyle = '#' + Math.floor(Math.random()*16777215).toString(16);
    ctx.fill();
    start += angle;
  });
}

// testes b√°sicos
console.assert(typeof fetch === 'function', 'Fetch API n√£o dispon√≠vel');

setInterval(carregarEstoque, 5000);
carregarEstoque();
</script>
</body>
</html>
